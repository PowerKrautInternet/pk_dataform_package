
/*config*/
let pk = require("../../sources")
let ref = pk.ref
let query = `
SELECT
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.DTCMEDIA_CRM_ID') AS DTCMEDIA_CRM_ID,
        RECEIVEDON,
        ACTION,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.TRAJECTID') as TRAJECT_TRAJECTID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.RELATIEID') as TRAJECT_RELATIEID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.DEALERID') as TRAJECT_DEALERID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.VERKOPERID') as TRAJECT_VERKOPERID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.AFLEVERGEBRUIKERID') as TRAJECT_AFLEVERGEBRUIKERID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.TRAJECTSTATUSID') as TRAJECTSTATUSID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.SOORTTRAJECTID') as TRAJECT_SOORTTRAJECTID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.TRAJECTAFSLUITREDENID') as TRAJECT_TRAJECTAFSLUITREDENID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.DEFINITIEFOFFERTEID') as TRAJECT_DEFINITIEFOFFERTEID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.PREVTRAJECTID') as TRAJECT_PREVTRAJECTID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.NEXTACTIEDATUM') as TRAJECT_NEXTACTIEDATUM,
        CAST(NULLIF(JSON_EXTRACT_SCALAR(PAYLOAD, '$.CREATIEDATUM'), "") AS DATETIME) as TRAJECT_CREATIEDATUM, 
        CAST(NULLIF(JSON_EXTRACT_SCALAR(PAYLOAD, '$.STARTDATUM'), "") AS DATE) as TRAJECT_STARTDATUM,
        CAST(NULLIF(JSON_EXTRACT_SCALAR(PAYLOAD, '$.AFGERONDDATUM'), "") AS DATETIME) as TRAJECT_AFGERONDDATUM, 
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.EXTERNLEADID') as TRAJECT_EXTERNLEADID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.DTCMEDIA_CRM_ID') as TRAJECT_DTCMEDIA_CRM_ID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.SOORTAUTO') as TRAJECT_SOORTAUTO,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.SOORTOFFERTEID') as TRAJECT_SOORTOFFERTEID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.TRAJECTKANS') as TRAJECT_TRAJECTKANS,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.MAILINGAANTAL') as TRAJECT_MAILINGAANTAL,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.HANDELSAUTO') as TRAJECT_HANDELSAUTO,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.EXTERNID') as TRAJECT_EXTERNID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.OMSCHRIJVING') as TRAJECT_OMSCHRIJVING,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.EERSTEKWALIFICATIE') as TRAJECT_EERSTEKWALIFICATIE,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.SOORTLEADSBRONID') as TRAJECT_SOORTLEADSBRONID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.LEADKLASSEID') as TRAJECT_LEADKLASSEID,        
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.NEXTACTIEID') as TRAJECT_NEXTACTIEID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.HERKOMSTID') as TRAJECT_HERKOMSTID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.BESTUURDERID') as TRAJECT_BESTUURDERID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.LEASEMIJID') as TRAJECT_LEASEMIJID,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.LEADSGROEPID') as TRAJECT_LEADSGROEPID,        
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.AUTONAAMKORT') as TRAJECT_AUTONAAMKORT,
        JSON_EXTRACT_SCALAR(PAYLOAD, '$.AUTONAAMLANG') as TRAJECT_AUTONAAMLANG

FROM (
   SELECT MAX(SCHEMA), PRIMARYFIELDHASH, MAX(PAYLOAD) as PAYLOAD, MAX(ACTION) as ACTION, MAX(RECEIVEDON) as RECEIVEDON
    FROM
      ${ref("df_rawdata_views", "samDataProducer_lasttransaction")} as first
     WHERE SCHEMA IN (SELECT schema FROM ${ref("df_rawdata_views", "samtablehashes")} WHERE tableName = 'TRAJECT')
     AND RECEIVEDON = (
        SELECT MAX(RECEIVEDON)
        FROM ${ref("df_rawdata_views", "samDataProducer_lasttransaction")} as second
        WHERE first.PRIMARYFIELDHASH = second.PRIMARYFIELDHASH and first.SCHEMA = second.SCHEMA)
    GROUP BY PRIMARYFIELDHASH
)

`
let refs = pk.getRefs()
module.exports = {query, refs}
